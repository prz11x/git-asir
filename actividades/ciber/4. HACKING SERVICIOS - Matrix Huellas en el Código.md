
# Controlar el sistema

TEMARIO: https://laaventuradeaprender.com/69-2/

En este pequeño universo, tu Linux hace de **Máquina Central**, un nodo que controla el flujo de información entre los humanos libres y las máquinas. Los alumnos son “operadores”, encargados de levantar accesos, crear identidades falsas, aislar directorios y conceder privilegios solo a quienes “existen dentro del sistema”.

El sistema está dividido en dos mundos:

_La Superficie (usuarios sin privilegios)_

_El Backdoor (usuarios con acceso sudo)_

La misión avanza en fases, y cada fase tiene su sentido dentro del lore.

---

# **FASE 1 — Generación de identidades (crear usuarios)**

La Resistencia necesita identidades nuevas para infiltrarse en Matrix.

Cada alumno debe crear:

- **3 usuarios sin privilegios**:
    - _trinity_
    - _apoc_
    - _switch_
- **1 usuario operador con privilegios sudo**:
    - _neo_

“neo” deberá ser añadido al grupo sudoers.

Instrucciones sugeridas (los alumnos deben descubrir qué significan las opciones):

```bash
sudo adduser trinity
sudo adduser apoc
sudo adduser switch
sudo adduser neo
sudo usermod -aG sudo neo

```

Justificación narrativa:

**Neo es “El Elegido”**, así que puede alterar las reglas del sistema.

Los demás son “agentes infiltrados” con permisos normales.

---

# **FASE 2 — Crear grupos: _Escuadrones de la Resistencia_**

La Resistencia funciona por células. Necesitamos 2 grupos:

- **zion** → humanos libres
- **matrix** → identidades falsas dentro del sistema

Asignación:

- _trinity_ y _neo_ deben estar en **zion**
- _apoc_ y _switch_ deben estar en **matrix**

El operador (neo) pertenece a los dos mundos, así que debe estar en ambos grupos.

```bash
sudo groupadd zion
sudo groupadd matrix

sudo usermod -aG zion neo
sudo usermod -aG zion trinity

sudo usermod -aG matrix neo
sudo usermod -aG matrix apoc
sudo usermod -aG matrix switch

```

Neo vive en el umbral entre los mundos. Sus permisos lo reflejan.

---

# **FASE 3 — Estructura de directorios: _Los Distritos de Matrix_**

Se pide crear:

### 1. **/mission-data**

Carpeta para las operaciones de la Resistencia, acceso exclusivo al grupo _zion_.

No debe ser visible para los usuarios del grupo _matrix_.

### 2. **/simulacion**

Carpeta donde residirán archivos falsos del “mundo simulado”.

Acceso libre para el grupo _matrix_, pero **solo lectura para zion** (ellos no deben ensuciarse demasiado con la ilusión).

### 3. **/backdoor**

Carpeta secreta, accesible solo por **neo**. El resto debe recibir un “Acceso denegado”.

Comandos sugeridos:

```bash
sudo mkdir /mission-data
sudo mkdir /simulacion
sudo mkdir /backdoor

# mission-data (solo zion)
sudo chown :zion /mission-data
sudo chmod 770 /mission-data

# simulacion (matrix rwx / zion r-x)
sudo chown :matrix /simulacion
sudo chmod 775 /simulacion

# backdoor (solo neo)
sudo chown neo:neo /backdoor
sudo chmod 700 /backdoor

```

La carpeta _backdoor_ representa la puerta por la que Neo accede al código subyacente de Matrix.


rui@rui-VMware-Virtual-Platform:~$ ll / | grep -E 'mission-data|simulacion|backdoor'
drwxr-xr-x   2 root root       4096 dic 11 10:51 backdoor/
drwxr-xr-x   2 root root       4096 dic 11 10:51 mission-data/
drwxr-xr-x   2 root root       4096 dic 11 10:50 simulacion/


rui@rui-VMware-Virtual-Platform:~$ sudo chown :zion /mission-data
rui@rui-VMware-Virtual-Platform:~$ sudo chmod 770 /mission-data
rui@rui-VMware-Virtual-Platform:~$ sudo chown :matrix /simulacion
rui@rui-VMware-Virtual-Platform:~$ sudo chmod 775 /simulacion
rui@rui-VMware-Virtual-Platform:~$ sudo chown neo:neo /backdoor
rui@rui-VMware-Virtual-Platform:~$ sudo chmod 700 /backdoor
rui@rui-VMware-Virtual-Platform:~$ ll / | grep -E 'mission-data|simulacion|backdoor'
drwx------   2 neo  neo          4096 dic 11 10:51 backdoor/
drwxrwx---   2 root zion         4096 dic 11 10:51 mission-data/
drwxrwxr-x   2 root matrix       4096 dic 11 10:50 simulacion/

---

# **FASE 4 — Pruebas de acceso: _El Oráculo y los obstáculos_**

1. **Entrar con cada usuario** y comprobar qué carpetas ven.
2. Crear un archivo dentro de /mission-data con usuarios que NO son del grupo → debe fallar.
3. Intentar listar /backdoor con un usuario que no sea neo → debe fallar.
4. Que /simulacion permita escribir a matrix, pero no a zion.

Esto entrena:

– su comprensión de permisos

– su uso de _su_, _ls -l_, _id_, _touch_, _mkdir_, _groups_, etc.

su trinity
Contraseña: 
trinity@rui-VMware-Virtual-Platform:/home/rui$ ls /backdoor/
ls: no se puede abrir el directorio '/backdoor/': Permiso denegado
trinity@rui-VMware-Virtual-Platform:/home/rui$ ls /mission-data/
trinity@rui-VMware-Virtual-Platform:/home/rui$ cd /mission-data/
trinity@rui-VMware-Virtual-Platform:/mission-data$ cd /simulacion/
trinity@rui-VMware-Virtual-Platform:/simulacion$ 

trinity@rui-VMware-Virtual-Platform:~$ ll / | grep -E 'mission-data|simulacion|backdoor'
drwx------   2 neo  neo          4096 dic 11 10:51 backdoor/
drwxrwx---   2 root zion         4096 dic 11 10:51 mission-data/
drwxrwxr-x   2 root matrix       4096 dic 11 10:50 simulacion/
trinity@rui-VMware-Virtual-Platform:~$ cd /simulacion/
trinity@rui-VMware-Virtual-Platform:/simulacion$ touch ejemplo.txt
touch: no se puede efectuar `touch' sobre 'ejemplo.txt': Permiso denegado

su apoc
Contraseña:

poc@rui-VMware-Virtual-Platform:/home/trinity$ cd
apoc@rui-VMware-Virtual-Platform:~$ cd /backdoor/
bash: cd: /backdoor/: Permiso denegado

apoc@rui-VMware-Virtual-Platform:~$ cd /mission-data/
bash: cd: /mission-data/: Permiso denegado

apoc@rui-VMware-Virtual-Platform:~$ cd /simulacion/
apoc@rui-VMware-Virtual-Platform:/simulacion$

apoc@rui-VMware-Virtual-Platform:/simulacion$ touch ejemplo.txt
apoc@rui-VMware-Virtual-Platform:/simulacion$ ls
ejemplo.txt

su switch
Contraseña:
switch@rui-VMware-Virtual-Platform:~$ cd /backdoor/
bash: cd: /backdoor/: Permiso denegado
switch@rui-VMware-Virtual-Platform:~$ cd /mission-data/
bash: cd: /mission-data/: Permiso denegado
switch@rui-VMware-Virtual-Platform:~$ cd /simulacion/
switch@rui-VMware-Virtual-Platform:/simulacion$


sudo su neo
[sudo] contraseña para neo:
neo@rui-VMware-Virtual-Platform:/simulacion$ cd
neo@rui-VMware-Virtual-Platform:~$ cd /backdoor/
neo@rui-VMware-Virtual-Platform:/backdoor$ cd /mission-data/
neo@rui-VMware-Virtual-Platform:/mission-data$ cd /simulacion/
neo@rui-VMware-Virtual-Platform:/simulacion$


---

# **FASE 5 — Mini misión final: _Neutralizar al Agente Smith_**

**smith** → representa al Agente Smith

Este usuario NO debe pertenecer a ningún grupo de la resistencia ni a matrix.

Debe tener una carpeta personal sin permisos para nadie más:

```bash
sudo adduser smith
sudo chmod 700 /home/smith

```

Debes demostrar que _smith_ no puede interactuar con las carpetas del sistema (mission-data, simulacion, backdoor) y explicar **por qué**, usando `ls -ld`, permisos y grupos.

rui@rui-VMware-Virtual-Platform:/home/apoc$ sudo chmod 700 /home/smith
rui@rui-VMware-Virtual-Platform:/home/apoc$ cd /home/smith/
rui@rui-VMware-Virtual-Platform:/home/apoc$ ll /home/ | grep smith
drwx------  2 smith       smith       4096 dic 11 11:40 smith/

su smith 
Contraseña: 
smith@rui-VMware-Virtual-Platform:/home/apoc$ cd /home/smith
smith@rui-VMware-Virtual-Platform:~$ pwd
/home/smith

smith@rui-VMware-Virtual-Platform:~$ ll /backdoor/
ls: no se puede abrir el directorio '/backdoor/': Permiso denegado
smith@rui-VMware-Virtual-Platform:~$ ll /mission-data/
ls: no se puede abrir el directorio '/mission-data/': Permiso denegado
smith@rui-VMware-Virtual-Platform:~$ ll /simulacion/
total 8
drwxrwxr-x  2 root matrix 4096 dic 11 11:37 ./
drwxr-xr-x 26 root root   4096 dic 11 10:51 ../
-rw-rw-r--  1 apoc apoc      0 dic 11 11:37 ejemplo.txt





# Matrix: Huellas en el Código

La Resistencia ha detectado alteraciones en el sistema.

Alguien ha entrado sin permiso. El sistema (Linux) registra todas las trazas, pero necesitan operadores capacitados para reconstruir lo ocurrido.

El alumno se convierte en **Analista de Zion**, encargado de rastrear la actividad de los usuarios creados en el Reto 1: _neo, trinity, apoc, switch, smith_.

El objetivo:

Descubrir **quién** ha accedido, **cuándo**, **desde dónde**, **qué ha tocado**, y **si ha conseguido privilegios** dentro de Matrix.

---

# **FASE 6 — La lluvia de código (logs en tiempo real)**

Orden del Oráculo: observar el flujo del sistema en directo.

1. Ver los mensajes del sistema en tiempo real:
    
    ```bash
    sudo journalctl -f
        ```
    dic 11 12:06:39 rui-VMware-Virtual-Platform su[5839]: (to rui) smith on pts/1
    dic 11 12:07:00 rui-VMware-Virtual-Platform sudo[5847]:      rui : TTY=pts/1 ; PWD=/home/rui ; USER=root ; COMMAND=/usr/bin/journalctl -f

1. Cambiar entre usuarios mientras _journalctl_ está abierto
    
    (por ejemplo, `su - trinity`, luego `exit`).
    
    
2. Detectar en el log:
    
    • el evento de autenticación
    
    • si el login se ha permitido o ha fallado
    

**Resultado esperado:** reconocer entradas como “session opened”, “session closed”, fallos PAM, etc.

dic 11 12:09:07 rui-VMware-Virtual-Platform su[5887]: (to neo) rui on pts/3
    dic 11 12:09:07 rui-VMware-Virtual-Platform su[5887]:  pam_unix(su:session): session opened for user neo(uid=1005) by rui(uid=1000)
    dic 11 12:10:24 rui-VMware-Virtual-Platform su[5887]: pam_unix(su:session): session closed for user neo
:

Cada login es una “vibración en el código de Matrix”, y journalctl es la pantalla donde llueve el código verde.

---

# **FASE 7 — El rastro de entrada y salida**

Aquí usamos **last**, **who**, **w**.

### 1. ¿Quién está conectado ahora mismo?

```bash
who
w

```

### 2. ¿Qué usuarios han entrado en el sistema en los últimos días?

```bash
last

```

### 3. ¿Se detectan accesos fallidos?

(En Distros Debian/Ubuntu)

```bash
sudo zgrep -i "failed" /var/log/auth.log*

```

Preguntas tipo misión:

- ¿Trinity accedió ayer?
- ¿Apoc intentó entrar varias veces y falló?
- ¿Neo ha usado sudo recientemente?
- ¿Smith existe en los logs aunque no debería moverse por el sistema?

---

# **FASE 8 — Sudo: quién ha manipulado Matrix**

```bash
sudo journalctl -u sudo

```

o en Ubuntu también:

```bash
sudo grep 'COMMAND=' /var/log/auth.log

```

Descubrir si “Neo ha modificado normas de la simulación” o si “Smith ha intentado elevarse”.

Tareas:

1. Ver qué comandos se han ejecutado con sudo.
2. Identificar el usuario que los ejecutó.
3. Detectar intentos de sudo fallidos.

2025-12-11T12:18:51.486653+01:00 rui-VMware-Virtual-Platform sudo:      rui : TTY=pts/1 ; PWD=/home/rui ; USER=root ; COMMAND=/usr/bin/grep COMMAND= /var/log/auth.log

2025-12-11T11:55:01.082450+01:00 rui-VMware-Virtual-Platform sudo:    smith : user NOT in sudoers ; TTY=pts/1 ; PWD=/home/smith ; USER=root ; COMMAND=/usr/bin/journalctl -f

Bonus para rizar el rizo:

```bash
sudo journalctl | grep sudo

```

---

# **FASE 9 — Huellas en el historial: _El Código dejado atrás_**

Revisar qué comandos ha ejecutado cada usuario.

Para ello, entrar como cada uno:

```bash
sudo su - trinity
history

```

trinity@rui-VMware-Virtual-Platform:~$ history
    1  history
    2  ls
    3  cd
    4  ls
    5  history

o inspeccionar los archivos:

- `~/.bash_history`

• `~/.zsh_history` (si procede)

Preguntas narrativas:

- ¿Quién creó un archivo dentro de /simulacion fuera de su hora de trabajo?

rui@rui-VMware-Virtual-Platform:~$ sudo grep '/simulacion' /var/log/auth.log

2025-12-11T10:50:35.217516+01:00 rui-VMware-Virtual-Platform sudo:      rui : TTY=pts/0 ; PWD=/home/rui ; USER=root ; COMMAND=/usr/bin/mkdir /simulacion

- ¿Quién intentó entrar a /backdoor aunque no tenía permisos?

sudo grep 'denied' /var/log/auth.log

2025-12-11T12:29:27.862391+01:00 rui-VMware-Virtual-Platform sudo:      rui : TTY=pts/2 ; PWD=/home/rui ; USER=root ; COMMAND=/usr/bin/grep denied /var/log/auth.log

- ¿Qué usuario ejecutó comandos sospechosos como `sudo su`?

sudo grep 'COMMAND=/usr/bin/su' /var/log/auth.log

2025-12-11T12:25:10.094301+01:00 rui-VMware-Virtual-Platform sudo:  trinity : user NOT in sudoers ; TTY=pts/2 ; PWD=/home/trinity ; USER=root ; COMMAND=/usr/bin/su rui

- ¿Acaso _Smith_ intentó copiar algo desde _mission-data_?

sudo journalctl | grep mission-data
[sudo] contraseña para rui: 
dic 11 10:51:16 rui-VMware-Virtual-Platform sudo[4774]:      rui : TTY=pts/0 ; PWD=/home/rui ; USER=root ; COMMAND=/usr/bin/mkdir /mission-data
dic 11 11:03:06 rui-VMware-Virtual-Platform sudo[4826]:      rui : TTY=pts/0 ; PWD=/home/rui ; USER=root ; COMMAND=/usr/bin/chown :zion /mission-data
dic 11 11:03:45 rui-VMware-Virtual-Platform sudo[4841]:      rui : TTY=pts/0 ; PWD=/home/rui ; USER=root ; COMMAND=/usr/bin/chmod 770 /mission-data


---

# **FASE 10 — Localizar la intrusión: reconstrucción forense**

> “Durante la noche, uno de los usuarios ha intentado manipular el código de Matrix.
> 
> El sistema registró 3 accesos fallidos, un uso indebido de sudo y una entrada en /simulacion fuera del horario.” _(Realiza con un usuario las acciones para mantener la ficción)_

Tu misión es:

1. Localizar esos eventos.
    
2. Determinar qué usuario lo hizo.
    
3. Extraer las líneas exactas de log donde ocurrió.
    
4. Preparar un informe breve tipo forense:
    
    • usuario implicado
    
    • hora
    
    • evento
    
    • interpretación técnica
    

sudo grep -i 'failed' /var/log/auth.log

2025-12-11T12:37:29.446836+01:00 rui-VMware-Virtual-Platform sudo:    smith : user NOT in sudoers ; TTY=pts/2 ; PWD=/simulacion ; USER=root ; COMMAND=/usr/bin/grep -i failed /var/log/auth.log

sudo grep -i 'authentication' /var/log/auth.log

2025-12-11T12:24:54.178244+01:00 rui-VMware-Virtual-Platform sudo: pam_unix(sudo:auth): authentication failure; logname=rui uid=1002 euid=0 tty=/dev/pts/2 ruser=trinity rhost=  user=trinity

sudo grep 'COMMAND=' /var/log/auth.log

2025-12-11T12:36:27.474650+01:00 rui-VMware-Virtual-Platform sudo:    smith : user NOT in sudoers ; TTY=pts/2 ; PWD=/simulacion ; USER=root ; COMMAND=/usr/bin/mkdir hola

sudo journalctl | grep '/simulacion'

dic 11 12:36:27 rui-VMware-Virtual-Platform sudo[6121]:    smith : user NOT in sudoers ; TTY=pts/2 ; PWD=/simulacion ; USER=root ; COMMAND=/usr/bin/mkdir hola
dic 11 12:37:29 rui-VMware-Virtual-Platform sudo[6127]:    smith : user NOT in sudoers ; TTY=pts/2 ; PWD=/simulacion ; USER=root ; COMMAND=/usr/bin/grep -i failed /var/log/auth.log


Aquí se cruzan:

- journalctl
- auth.log
- last
- history
- permisos